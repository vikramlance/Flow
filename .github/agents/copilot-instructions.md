# Flow Development Guidelines

Auto-generated from all feature plans. Last updated: 2026-02-20

## Active Technologies
- Kotlin 2.0.20 + Jetpack Compose + Material 3, Hilt 2.52 (DI), Room 2.6.1 (SQLite), DataStore Preferences, Navigation Compose 2.8.x, Coroutines + StateFlow (001-task-history-help)
- Room 2.6.1  SQLite via 3 tables: `tasks`, `task_logs`, `daily_progress`. DB version **5** (no migration needed for this feature) (001-task-history-help)
- Kotlin 2.0 + Jetpack Compose BOM ~2024.09.02, Material3 1.3.0, Room 2.6, Hilt, KSP, Coroutines + Flow (002-progress-gamification)
- Room/SQLite (local-first, DB version 6) (002-progress-gamification)
- Kotlin 2.0 (K2 compiler) + Jetpack Compose + Material 3 (BOM 2024.09.02), Hilt 2.52, Navigation Compose 2.8.x (003-fix-tasks-analytics)
- Room 2.6.1 — AppDatabase v7 (no schema migration needed for this feature) (003-fix-tasks-analytics)
- Kotlin 2.0, JVM target 11 + Jetpack Compose (BOM aligned), Material 3, Hilt 2.x, Room 2.6, DataStore Preferences, Kotlin Coroutines + Flow (001-ui-bug-fixes)
- Room / SQLite  schema version 7; `task_logs` has UNIQUE(taskId, date) (001-ui-bug-fixes)
- Kotlin 2.0 (K2 compiler) + Jetpack Compose + Material 3 (BOM 2024.09.02), Hilt 2.52, Navigation Compose 2.8.x, Material Icons Extended (already in BOM classpath) (004-task-ui-scheduling)
- Room 2.6.1 — AppDatabase (no version bump; `scheduleMask` already exists) (004-task-ui-scheduling)
- Kotlin (Android 14, API 34), Compose + Android Jetpack Compose (androidx.compose) (005-fix-task-end-time)
- Room DB (005-fix-task-end-time)
- Kotlin 1.9, Android API 34 (minSdk 24) (005-fix-task-end-time)
- Room (`TaskEntity.dueDate: Long?`, stored as epoch millis) (005-fix-task-end-time)
- Kotlin 2.0 (JVM target 11) (005-fix-task-end-time)
- Room 2.6 (`TaskDao`, `TaskEntity`) — SQLite, local-only, no network (005-fix-task-end-time)

- Kotlin 2.0.20 (K2 compiler); JVM target Java 8 + Jetpack Compose BOM 2024.09.02, Material 3, Hilt 2.52, Room 2.6.1, DataStore 1.1.1, Lifecycle 2.8.6, Navigation Compose 2.8.x, Hilt Navigation Compose 1.2.0 (001-app-analysis)

## Project Structure

```text
src/
tests/
```

## Commands

# Add commands for Kotlin 2.0.20 (K2 compiler); JVM target Java 8

## Code Style

Kotlin 2.0.20 (K2 compiler); JVM target Java 8: Follow standard conventions

## Recent Changes
- 005-fix-task-end-time: Added Kotlin 2.0 (JVM target 11)
- 005-fix-task-end-time: Added Kotlin 1.9, Android API 34 (minSdk 24)
- 005-fix-task-end-time: Added Kotlin (Android 14, API 34), Compose + Android Jetpack Compose (androidx.compose)


<!-- MANUAL ADDITIONS START -->

## Repository Hygiene

- **Never create output or log files at the repo root.** All build
  command output captures, test result text dumps, and any other
  temporary/ad-hoc text files produced during development MUST be
  written to `logs/` at the repo root. That directory is in
  `.gitignore` and is never committed.
- **Never create internal script files (.sh, .ps1, etc.) at the repo root.** 
  Temporary scripts used for automated changes, search/replace, or one-off runs
  must always be stored in `.specify/scripts/backup` to keep the root directory
  organized and clean.
- Examples of what belongs in `logs/` (not at root): `build_output.txt`,
  `unit_test_out.txt`, `device_test*.txt`, `instrumented_out.txt`,
  `test_result.txt`, or any `*.txt` produced by redirecting a shell command.
- Redirect pattern: `./gradlew <task> 2>&1 | Tee-Object logs/<name>.txt`
- Delete stale log files from `logs/` once they are no longer needed.
- Do NOT create new `.gitignore` entries for individual output file names;
  the single `logs/` directory rule covers all cases.
- `build/` directories are generated by Gradle and already ignored;
  never commit build artifacts.

## Repository Layer Rules

- **Never normalise stored field values in `updateTask`.**
  `normaliseToMidnight()` (and any equivalent time-stripping function) is
  appropriate ONLY for computing day-boundary keys used in date filtering,
  grouping, or comparison queries. It MUST NOT be applied to a field value
  that is about to be written to the DAO/database (e.g.
  `dueDate = task.dueDate?.let { normaliseToMidnight(it) }` inside
  `updateTask()` is a bug — remove it).
- **Repository is a thin persistence layer.** Business-logic transformations
  (like defaulting a time to end-of-day, or stripping sub-minute precision)
  belong in the ViewModel or UI layer — not in the Repository's save methods.
  The Repository must store exactly what the caller sends.
- **Code review rule.** Any PR that introduces `normaliseToMidnight(it)` (or
  similar time-stripping calls) on a field being *set* during a save/update
  operation MUST be flagged as a defect before merging.

## Test Coverage Rules

- **End-to-end save path tests are mandatory for date/time storage features.**
  A test that calls a utility function directly (e.g. `resolveEndTime(...)`)
  is NOT sufficient to verify that the value is correctly persisted. Every
  date/time field storage feature MUST include at least one test that:
  1. Sets up a task with a known time value.
  2. Calls the ViewModel save method (e.g. `viewModel.updateTask(...)` or
     `viewModel.saveEditTask(...)`).
  3. Reads back from the Repository or DAO.
  4. Asserts the stored H:M value equals what was passed in.
- **Do not rely on unit tests of utility functions to prove persistence
  correctness.** Utility function tests prove the function; they do not prove
  the call site uses the function's output correctly, and they do not prove
  the Repository doesn't overwrite the result.

<!-- MANUAL ADDITIONS END -->
